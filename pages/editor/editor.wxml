<!--editor.wxml-->
<view class="container">
  <!-- 九宫格编辑区域 -->
  <view class="grid-editor-container">
    <view class="grid-template" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; {{currentTemplate.style}}">
      <view 
        class="grid-cell {{cell.class || ''}} {{dragOverCell === index ? 'drag-over' : ''}}"
        wx:for="{{gridCells}}" 
        wx:for-item="cell"
        wx:key="index"
        data-cell-index="{{index}}"
        bindtouchstart="onCellTouchStart"
        bindtouchmove="onCellTouchMove"
        bindtouchend="onCellTouchEnd"
        bindtap="onCellTap"
        style="grid-column: span {{cell.columnSpan}}; grid-row: span {{cell.rowSpan}};"
        >
        
        <!-- 格子中的图片 -->
        <view wx:if="{{cell.photoSrc}}" class="cell-photo {{draggingCell === index ? 'dragging' : ''}}">
          <image 
            src="{{cell.photoSrc}}" 
            mode="aspectFill"
            class="photo-image"
          ></image>
          
          <!-- 拖拽指示器 -->
          <view wx:if="{{draggingCell === index}}" class="drag-indicator">
            <text class="drag-text">拖拽到其他格子</text>
          </view>
        </view>
        
        <!-- 空格子提示 -->
        <view wx:else class="empty-cell">
          <text class="empty-text">+</text>
        </view>
        
        <!-- 格子编号（调试用） -->
        <!-- <view class="cell-number">{{index + 1}}</view> -->
      </view>
    </view>
  </view>

  <!-- 底部工具栏 -->
  <view class="bottom-toolbar">  
    <scroll-view class="template-scroll" scroll-x="true">
      <view class="template-item {{selectedLayoutIndex === index ? 'active' : ''}}" 
            wx:for="{{filteredLayouts}}" 
            wx:key="index"
            bindtap="selectLayout"
            data-index="{{index}}">
        <view class="template-preview">
          <view class="template-grid" style="{{item.style}}">
            <view class="template-grid-cell {{cell.class}}" 
                  wx:for="{{item.cells}}" 
                  wx:for-item="cell" 
                  wx:key="cellIndex"
                  style="grid-column: span {{cell.columnSpan}}; grid-row: span {{cell.rowSpan}};">
            </view>
          </view>
        </view>
        <text class="template-name">{{item.name}}</text>
      </view>
    </scroll-view>
    <!-- 功能按钮 -->
    <view class="function-buttons">
      <view class="func-btn">
        <text class="func-label">布局</text>
      </view>
      <view class="func-btn">
      </view>
      <view class="func-btn save-btn" bindtap="savePuzzle">
        <text class="func-label">保存</text>
      </view>
    </view>
  </view>

  <!-- 图片裁剪弹窗 -->
  <view class="crop-modal {{showCropModal ? 'show' : ''}}">
    <view class="crop-modal-content">
      <view class="crop-header">
        <text class="crop-title">裁剪</text>
        <text class="close-btn" bindtap="closeCropModal">×</text>
      </view>
      
      <view class="crop-container">
        <view class="crop-image-wrapper">
          <image 
            src="{{cropImageSrc}}" 
            mode="widthFix"
            class="crop-image"
            style="width: 100%; max-width: 300px; transform: scale({{cropScale}}); transform-origin: center;"
          ></image>
          
          <!-- 裁剪框 -->
          <view 
            class="crop-box"
            style="left: {{cropX * 300 / imageWidth * cropScale}}px; top: {{cropY * 300 / imageWidth * cropScale}}px; width: {{cropWidth * 300 / imageWidth}}px; height: {{cropHeight * 300 / imageWidth}}px;"
            bindtouchstart="onCropTouchStart"
            bindtouchmove="onCropTouchMove"
            bindtouchend="onCropTouchEnd"
          >
            <view class="crop-border"></view>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="crop-actions">
          <button class="crop-btn confirm-btn" bindtap="confirmCrop">确定</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 隐藏的canvas用于生成图片 -->
  <canvas 
    type="2d" 
    id="puzzleCanvas" 
    style="position: absolute; left: -9999px; top: -9999px; width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
  ></canvas>
  
  <!-- 隐藏的canvas用于图片裁剪 -->
  <canvas 
    type="2d" 
    id="cropCanvas" 
    style="position: absolute; left: -9999px; top: -9999px; width: 300px; height: 300px;"
  ></canvas>

  <!-- 加载提示 -->
  <view class="loading-overlay {{isLoading ? 'show' : ''}}">
    <view class="loading-content">
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>
</view>