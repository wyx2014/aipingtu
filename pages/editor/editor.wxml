<!--editor.wxml-->
<view class="container">
  <!-- 顶部工具栏 -->
  <view class="toolbar">
    <view class="toolbar-left">
      <text class="back-btn" bindtap="goBack">‹ 返回</text>
    </view>
    <view class="toolbar-center">
      <!-- <text class="title">开始创作吧</text> -->
    </view>
    <view class="toolbar-right">
      <text class="save-btn" bindtap="savePuzzle">保存</text>
    </view>
  </view>

  <!-- 九宫格编辑区域 -->
  <view class="grid-editor-container">
    <view class="grid-template {{currentTemplate.gridClass}}" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;">
      <view 
        class="grid-cell {{item.class || ''}} {{dragOverCell === index ? 'drag-over' : ''}}"
        wx:for="{{gridCells}}" 
        wx:key="index"
        data-cell-index="{{index}}"
        bindtouchstart="onCellTouchStart"
        bindtouchmove="onCellTouchMove"
        bindtouchend="onCellTouchEnd"
        bindtap="onCellTap">
        
        <!-- 格子中的图片 -->
        <view wx:if="{{item.photoSrc}}" class="cell-photo {{draggingCell === index ? 'dragging' : ''}}">
          <image 
            src="{{item.photoSrc}}" 
            mode="aspectFill"
            class="photo-image"
          ></image>
          
          <!-- 拖拽指示器 -->
          <view wx:if="{{draggingCell === index}}" class="drag-indicator">
            <text class="drag-text">拖拽到其他格子</text>
          </view>
        </view>
        
        <!-- 空格子提示 -->
        <view wx:else class="empty-cell">
          <text class="empty-text">+</text>
        </view>
        
        <!-- 格子编号（调试用） -->
        <view class="cell-number">{{index + 1}}</view>
      </view>
    </view>
  </view>

  <!-- 底部工具栏 -->
  <view class="bottom-toolbar">
    <!-- 照片列表 -->
    <scroll-view class="photo-list" scroll-x="true">
      <view class="photo-thumb" wx:for="{{remainingPhotos}}" wx:key="index" bindtap="addPhotoToCanvas" data-src="{{item}}">
        <image src="{{item}}" mode="aspectFill" class="thumb-image"></image>
      </view>
    </scroll-view>
    
    <!-- 功能按钮 -->
    <view class="function-buttons">
      <view class="func-btn" bindtap="addText">
        <text class="func-icon">T</text>
        <text class="func-label">文字</text>
      </view>
      
      <view class="func-btn" bindtap="addSticker">
        <text class="func-icon">☆</text>
        <text class="func-label">贴纸</text>
      </view>
      
      <view class="func-btn" bindtap="applyFilter">
        <text class="func-icon">◐</text>
        <text class="func-label">滤镜</text>
      </view>
      
      <view class="func-btn" bindtap="adjustBackground">
        <text class="func-icon">⬜</text>
        <text class="func-label">背景</text>
      </view>
    </view>
  </view>

  <!-- 滤镜选择弹窗 -->
  <view class="filter-modal {{showFilterModal ? 'show' : ''}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">选择滤镜</text>
        <text class="close-btn" bindtap="closeFilterModal">×</text>
      </view>
      <scroll-view class="filter-list" scroll-x="true">
        <view class="filter-item {{currentFilter === item.name ? 'active' : ''}}" 
              wx:for="{{filters}}" 
              wx:key="name"
              bindtap="selectFilter"
              data-filter="{{item.name}}">
          <view class="filter-preview" style="{{item.style}}"></view>
          <text class="filter-name">{{item.label}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 文字编辑弹窗 -->
  <view class="text-modal {{showTextModal ? 'show' : ''}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">添加文字</text>
        <text class="close-btn" bindtap="closeTextModal">×</text>
      </view>
      <view class="text-input-area">
        <textarea 
          placeholder="请输入文字内容" 
          value="{{textContent}}"
          bindinput="onTextInput"
          class="text-input"
          maxlength="100">
        </textarea>
        <view class="text-style-options">
          <view class="style-group">
            <text class="style-label">颜色:</text>
            <view class="color-options">
              <view class="color-item {{textColor === item ? 'active' : ''}}" 
                    wx:for="{{textColors}}" 
                    wx:key="*this"
                    style="background-color: {{item}};"
                    bindtap="selectTextColor"
                    data-color="{{item}}">
              </view>
            </view>
          </view>
          <view class="style-group">
            <text class="style-label">大小:</text>
            <slider 
              value="{{textSize}}" 
              min="20" 
              max="80" 
              bindchange="onTextSizeChange"
              class="size-slider">
            </slider>
          </view>
        </view>
        <button class="confirm-btn" bindtap="confirmAddText">确定</button>
      </view>
    </view>
  </view>

  <!-- 加载提示 -->
  <view class="loading-overlay {{isLoading ? 'show' : ''}}">
    <view class="loading-content">
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>
</view>